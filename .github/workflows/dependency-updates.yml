name: Dependency Updates

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: "0 9 * * 1"
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

env:
  NODE_VERSION: "22"
  BRANCH_NAME: "automated/dependency-updates"

jobs:
  check-updates:
    name: Check for Updates
    runs-on: ubuntu-latest
    outputs:
      has-updates: ${{ steps.check.outputs.has-updates }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install npm-check-updates
        run: npm install -g npm-check-updates

      - name: Check for updates
        id: check
        run: |
          # Check if there are any updates available
          UPDATES=$(ncu --jsonUpgraded 2>/dev/null || echo "{}")
          if [ "$UPDATES" = "{}" ]; then
            echo "No updates available"
            echo "has-updates=false" >> $GITHUB_OUTPUT
          else
            echo "Updates available:"
            echo "$UPDATES" | jq .
            echo "has-updates=true" >> $GITHUB_OUTPUT
          fi

  create-pr:
    name: Create Update PR
    runs-on: ubuntu-latest
    needs: check-updates
    if: needs.check-updates.outputs.has-updates == 'true'
    outputs:
      pr-number: ${{ steps.create-pr.outputs.pull-request-number }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GEOMAN_RELEASE_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install npm-check-updates
        run: npm install -g npm-check-updates

      - name: Update dependencies
        id: update
        run: |
          # Get update summary before updating
          UPDATES=$(ncu --jsonUpgraded 2>/dev/null || echo "{}")
          echo "updates<<EOF" >> $GITHUB_OUTPUT
          echo "$UPDATES" | jq -r 'to_entries | .[] | "- \(.key): \(.value)"' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Update package.json
          ncu -u

          # Install updated dependencies
          npm install

      - name: Bump patch version
        id: version
        run: |
          NEW_VERSION=$(npm version patch --no-git-tag-version)
          echo "new-version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"

      - name: Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GEOMAN_RELEASE_TOKEN || secrets.GITHUB_TOKEN }}
          commit-message: "chore(deps): update dependencies"
          branch: ${{ env.BRANCH_NAME }}
          delete-branch: true
          title: "chore(deps): automated dependency updates"
          body: |
            ## Automated Dependency Updates

            This PR was automatically created by the dependency update workflow.

            ### Updated packages:
            ${{ steps.update.outputs.updates }}

            ### Version bump:
            ${{ steps.version.outputs.new-version }}

            ---
            *This PR will be automatically merged and released if all checks pass.*
          labels: |
            dependencies
            automated

  wait-for-ci:
    name: Wait for CI
    runs-on: ubuntu-latest
    needs: create-pr
    if: needs.create-pr.outputs.pr-number

    steps:
      - name: Wait for CI checks to complete
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ env.BRANCH_NAME }}
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          check-name: "Test on Node.js 22"
          wait-interval: 30
          allowed-conclusions: success

  auto-merge-and-release:
    name: Auto-merge and Release
    runs-on: ubuntu-latest
    needs: [create-pr, wait-for-ci]
    if: needs.create-pr.outputs.pr-number

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GEOMAN_RELEASE_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Merge PR
        run: |
          gh pr merge ${{ needs.create-pr.outputs.pr-number }} --squash --auto
        env:
          GH_TOKEN: ${{ secrets.GEOMAN_RELEASE_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Wait for merge
        run: |
          for i in {1..30}; do
            STATE=$(gh pr view ${{ needs.create-pr.outputs.pr-number }} --json state -q '.state')
            if [ "$STATE" = "MERGED" ]; then
              echo "PR merged successfully"
              exit 0
            fi
            echo "Waiting for PR to merge... (attempt $i/30)"
            sleep 10
          done
          echo "PR merge timeout"
          exit 1
        env:
          GH_TOKEN: ${{ secrets.GEOMAN_RELEASE_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Checkout merged code
        uses: actions/checkout@v4
        with:
          ref: master
          fetch-depth: 0
          token: ${{ secrets.GEOMAN_RELEASE_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Get new version
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Releasing version: $VERSION"

      - name: Create and push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v${{ steps.version.outputs.version }}" -m "Release v${{ steps.version.outputs.version }}"
          git push origin "v${{ steps.version.outputs.version }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GEOMAN_RELEASE_TOKEN || secrets.GITHUB_TOKEN }}
